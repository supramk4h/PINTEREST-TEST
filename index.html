<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inspire Board</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìå</text></svg>">

<style>
:root {
  --primary: #e60023;
  --primary-light: #fdeef1;
  --white: #ffffff;
  --gray-50: #f8f9fa;
  --gray-100: #f1f3f5;
  --gray-200: #e9ecef;
  --gray-300: #dee2e6;
  --gray-700: #495057;
  --gray-800: #343a40;
  --gray-900: #212529;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --card: var(--white);
  --border: var(--gray-200);
  --shadow: var(--shadow-md);
}

.dark-mode {
  --white: #0d1117;
  --gray-50: #161b22;
  --gray-100: #21262d;
  --gray-200: #30363d;
  --gray-300: #484f58;
  --gray-700: #8b949e;
  --gray-800: #c9d1d9;
  --gray-900: #f0f6fc;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.25);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.35);
  --card: var(--gray-50);
  --border: var(--gray-300);
  --shadow: var(--shadow-md);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--white);
  color: var(--gray-900);
  transition: background-color 0.3s ease, color 0.3s ease;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
}
/* ---------- AUTH MODAL ---------- */
#auth-container {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: calc(100vh - 72px);
  padding: 40px 20px;
  background: var(--white);
}

.auth-modal {
  max-width: 400px;
  width: 100%;
  animation: fadeIn 0.3s ease;
}

.auth-form {
  background: var(--card);
  border-radius: 32px;
  padding: 48px 40px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
}

.auth-header {
  text-align: center;
  margin-bottom: 32px;
}

.auth-header h2 {
  font-size: 32px;
  color: var(--gray-900);
  margin-bottom: 8px;
  font-weight: 700;
}

.auth-header p {
  font-size: 14px;
  color: var(--gray-700);
}

.auth-form-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.auth-form-content .form-group {
  margin: 0;
}

.auth-form-content label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: 8px;
}

.auth-form-content input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--gray-200);
  border-radius: 16px;
  font-size: 16px;
  background: var(--white);
  color: var(--gray-900);
  transition: all 0.2s ease;
}

.auth-form-content input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(230, 0, 35, 0.1);
}

.auth-form-content input::placeholder {
  color: var(--gray-300);
}

.auth-btn {
  background: var(--primary);
  color: white;
  border: none;
  padding: 14px 24px;
  border-radius: 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
}

.auth-btn:hover {
  background: #d50c22;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.auth-btn:active {
  transform: translateY(0);
}

.auth-divider {
  text-align: center;
  position: relative;
  margin: 20px 0;
}

.auth-divider::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: var(--border);
}

.auth-divider span {
  background: var(--card);
  padding: 0 16px;
  color: var(--gray-600);
  font-size: 14px;
  position: relative;
  z-index: 1;
}

.auth-switch {
  text-align: center;
  font-size: 14px;
  color: var(--gray-700);
  margin-top: 24px;
}

.auth-link {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  margin-left: 4px;
}

.auth-link:hover {
  text-decoration: underline;
}

/* Auth Error Messages */
.auth-error {
  background: #fee;
  border: 1px solid #fcc;
  color: #d00;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  margin-bottom: 16px;
  display: none;
}

.auth-error.show {
  display: block;
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* User Profile in Dropdown */
#userProfileSection {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 18px;
}

.user-details h4 {
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: 2px;
}

.user-details p {
  font-size: 12px;
  color: var(--gray-700);
}

#logoutBtn {
  width: 100%;
  padding: 8px 16px;
  background: var(--gray-50);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--gray-900);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

#logoutBtn:hover {
  background: var(--gray-100);
}

/* Loading state for auth */
.auth-btn.loading {
  opacity: 0.7;
  cursor: not-allowed;
  position: relative;
  color: transparent;
}

.auth-btn.loading::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  top: 50%;
  left: 50%;
  margin-left: -10px;
  margin-top: -10px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
/* ---------- ROSE PETALS ---------- */
.petal {
  position: fixed;
  pointer-events: none;
  z-index: 9999;
  font-size: 20px;
  opacity: 0;
  animation: fall linear forwards;
  user-select: none;
}

@keyframes fall {
  0% {
    opacity: 0;
    transform: translateY(-20px) rotate(0deg);
  }
  10% {
    opacity: 0.8;
  }
  100% {
    opacity: 0;
    transform: translateY(100vh) rotate(360deg);
  }
}

/* ---------- NAVBAR ---------- */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 72px;
  padding: 0 24px;
  background: var(--card);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  z-index: 1000;
  box-shadow: var(--shadow-sm);
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 22px;
  color: var(--primary);
  text-decoration: none;
}

.logo span {
  width: 42px;
  height: 42px;
  background: var(--primary);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

/* ---------- PROFILE ---------- */
.profile {
  position: relative;
}

.profile-btn {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: none;
  color: var(--gray-800);
  transition: all 0.2s ease;
}

.profile-btn:hover {
  background: var(--gray-200);
}

.profile-btn svg {
  width: 22px;
  height: 22px;
}

/* ---------- DROPDOWN ---------- */
.dropdown {
  position: absolute;
  right: 0;
  top: 54px;
  background: var(--card);
  border-radius: 16px;
  width: 220px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  display: none;
  overflow: hidden;
  z-index: 1001;
}

.dropdown.show { 
  display: block; 
  animation: dropdownAppear 0.2s ease;
}

.drop-item {
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  font-size: 14px;
  color: var(--gray-900);
  background: none;
  border: none;
  width: 100%;
  text-align: left;
  transition: background-color 0.2s ease;
}

.drop-item:hover {
  background-color: var(--gray-50);
}

.drop-item svg {
  width: 18px;
  height: 18px;
}

/* ---------- IOS SWITCH ---------- */
.switch {
  margin-left: auto;
  width: 42px;
  height: 24px;
  background: var(--gray-300);
  border-radius: 12px;
  position: relative;
  transition: .3s;
  cursor: pointer;
  flex-shrink: 0;
}

.switch::after {
  content: "";
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: .3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.switch.active {
  background: #22c55e;
}

.switch.active::after {
  left: 20px;
}

/* Main content */
.main-content {
  margin-top: 72px;
  padding: 24px;
  flex: 1;
}

/* GRID - Pinterest Style */
.grid {
  column-count: 5;
  column-gap: 16px;
  margin: 0 auto;
  max-width: 1400px;
  min-height: 200px;
}

@media (max-width: 1200px) {
  .grid { column-count: 4; }
}

@media (max-width: 900px) {
  .grid { column-count: 3; }
}

@media (max-width: 600px) {
  .grid { column-count: 2; }
  .main-content { padding: 16px; }
}

@media (max-width: 400px) {
  .grid { column-count: 2; }
  .main-content { padding: 12px; }
}

/* CARD */
.card {
  break-inside: avoid;
  margin-bottom: 16px;
  border-radius: 16px;
  overflow: hidden;
  position: relative;
  background: var(--white);
  box-shadow: var(--shadow-md);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
              box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation: cardAppear 0.5s ease forwards;
  opacity: 0;
  transform: translateY(20px);
}

@keyframes cardAppear {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-lg);
}

.card-image {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 16px;
  cursor: zoom-in;
  transition: opacity 0.3s ease;
}

.card-image.loading {
  opacity: 0;
}

.card-image.loaded {
  opacity: 1;
}

/* Card Actions */
.card-actions {
  position: absolute;
  bottom: 12px;
  right: 12px;
  display: flex;
  gap: 8px;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s ease;
}

.card:hover .card-actions {
  opacity: 1;
  transform: translateY(0);
}

.action-button {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 16px;
  color: var(--gray-800);
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.action-button:hover {
  background: white;
  transform: scale(1.1);
}

.like-heart {
  position: fixed;
  font-size: 60px;
  pointer-events: none;
  animation: popHeart 0.8s ease-out forwards;
  transform: translate(-50%, -50%);
  z-index: 3000;
}

@keyframes popHeart {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.2);
  }
  40% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.3);
  }
  70% {
    transform: translate(-50%, -70%) scale(1);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -120%) scale(0.8);
  }
}

/* 3-DOT MENU */
.three-dot-menu {
  position: absolute;
  top: 12px;
  right: 12px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 5;
}

.card:hover .three-dot-menu {
  opacity: 1;
}

.menu-button {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  color: var(--gray-800);
  transition: all 0.2s ease;
}

.menu-button:hover {
  background: white;
}

.menu-dropdown {
  position: absolute;
  top: 40px;
  right: 0;
  background: var(--white);
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  min-width: 180px;
  overflow: hidden;
  z-index: 100;
  display: none;
  animation: dropdownAppear 0.2s ease;
  border: 1px solid var(--border);
}

@keyframes dropdownAppear {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.menu-dropdown.show {
  display: block;
}

.menu-item {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  font-size: 14px;
  color: var(--gray-900);
  transition: background-color 0.2s ease;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}

.menu-item:hover {
  background-color: var(--gray-50);
}

.menu-item.delete {
  color: #dc3545;
}

/* NOTE BUBBLE - Thinking Cloud */
.note-bubble {
  position: absolute;
  top: 12px;
  left: 12px;
  right: 12px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 12px 16px;
  font-size: 13px;
  line-height: 1.4;
  color: var(--gray-800);
  box-shadow: var(--shadow-md);
  border: 1px solid rgba(0, 0, 0, 0.05);
  z-index: 2;
  display: none;
}

.note-bubble:before {
  content: '';
  position: absolute;
  top: 100%;
  left: 24px;
  border-width: 8px 8px 0;
  border-style: solid;
  border-color: rgba(255, 255, 255, 0.95) transparent transparent;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
}

.note-bubble.show {
  display: block;
  animation: bubbleAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes bubbleAppear {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.note-bubble .note-content {
  font-style: italic;
}

/* MODAL - Pinterest Style */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--white);
  border-radius: 24px;
  width: 90%;
  max-width: 1400px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  animation: modalSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  border: 1px solid var(--border);
}

@keyframes modalSlide {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  padding: 20px 24px;
  display: flex;
  justify-content: flex-end;
  border-bottom: 1px solid var(--gray-200);
}

.modal-close {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
  color: var(--gray-800);
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: var(--gray-200);
  transform: rotate(90deg);
}

.modal-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

@media (max-width: 900px) {
  .modal-content {
    flex-direction: column;
  }
}

/* Main Image Area */
.main-image-container {
  flex: 1;
  padding: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gray-50);
  position: relative;
  min-height: 400px;
  overflow: hidden;
}

.main-image {
  max-width: 100%;
  max-height: 60vh;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: var(--shadow-md);
}

/* Related Images */
.related-container {
  width: 400px;
  padding: 24px;
  border-left: 1px solid var(--gray-200);
  overflow-y: auto;
  max-height: 70vh;
}

@media (max-width: 900px) {
  .related-container {
    width: 100%;
    border-left: none;
    border-top: 1px solid var(--gray-200);
    max-height: 300px;
  }
}

.related-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-800);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.related-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

@media (max-width: 600px) {
  .related-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.related-card {
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  background: var(--white);
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
}

.related-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.related-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  display: block;
}

/* HEART ANIMATION */
.heart-animation {
  position: fixed;
  pointer-events: none;
  z-index: 1001;
  font-size: 0;
  opacity: 0;
  transition: all 0.5s ease;
}

.heart-animation.show {
  font-size: 80px;
  opacity: 1;
  animation: heartFloat 1s ease forwards;
}

@keyframes heartFloat {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  15% {
    transform: translate(-50%, -50%) scale(1.2);
    opacity: 1;
  }
  30% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -150%) scale(0.5);
  }
}

/* NOTE EDITOR */
.note-editor-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  animation: fadeIn 0.3s ease;
}

.note-editor {
  background: var(--white);
  border-radius: 20px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  box-shadow: var(--shadow-lg);
  animation: modalSlide 0.3s ease;
  border: 1px solid var(--border);
}

.note-editor-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.note-editor-textarea {
  width: 100%;
  height: 120px;
  padding: 12px;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  margin-bottom: 20px;
  background: var(--white);
  color: var(--gray-900);
  transition: border-color 0.2s ease;
}

.note-editor-textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.note-editor-buttons {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.editor-button {
  padding: 10px 20px;
  border-radius: 24px;
  border: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.editor-button.cancel {
  background: var(--gray-100);
  color: var(--gray-700);
}

.editor-button.save {
  background: var(--primary);
  color: white;
}

.editor-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* IMAGE COUNTER */
.image-counter {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--white);
  padding: 10px 16px;
  border-radius: 20px;
  box-shadow: var(--shadow-md);
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-800);
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 1px solid var(--border);
}

/* NOTIFICATION */
.notification {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--white);
  padding: 12px 24px;
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 1001;
  animation: slideDown 0.3s ease;
  border: 1px solid var(--border);
}

@keyframes slideDown {
  from {
    top: -100px;
    opacity: 0;
  }
  to {
    top: 100px;
    opacity: 1;
  }
}

.notification.show {
  display: flex;
}

/* FILE UPLOAD */
.upload-button {
  display: none;
}

/* IDLE MESSAGE */
.idle-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--card);
  padding: 40px;
  border-radius: 24px;
  text-align: center;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
  z-index: 100;
  display: none;
  max-width: 400px;
  width: 90%;
}

.idle-message.show {
  display: block;
  animation: fadeIn 0.3s ease;
}

.idle-icon {
  font-size: 48px;
  margin-bottom: 20px;
  opacity: 0.7;
}

.idle-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--gray-900);
}

.idle-text {
  font-size: 14px;
  color: var(--gray-700);
  margin-bottom: 20px;
  line-height: 1.5;
}

/* Empty State Button */
.empty-state-button {
  padding: 12px 24px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.empty-state-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* ALIGNMENT FIXES */
.main-image-container {
  display: flex;
  align-items: center;
  justify-content: center;
}

.related-container {
  display: flex;
  flex-direction: column;
}

.related-grid {
  flex: 1;
  align-content: flex-start;
}

.grid {
  min-height: 200px;
}

/* Ensure body takes full height */
html, body {
  height: 100%;
}

/* LOADING OVERLAY */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--white);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 1;
  transition: opacity 0.5s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: 16px;
  color: var(--gray-700);
  font-weight: 500;
}
</style>
</head>
<body>
<!-- Auth Container (Visible when not logged in) -->
<div id="auth-container" style="display: none; margin-top: 72px;">
  <div class="auth-modal">
    <!-- Login Form -->
    <div id="login-form" class="auth-form">
      <div class="auth-header">
        <h2>Welcome back to Inspire</h2>
        <p>Login to see your boards</p>
      </div>
      
      <form id="loginForm" class="auth-form-content">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="you@example.com" required>
        </div>
        
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        
        <button type="submit" class="auth-btn">Log in</button>
        
        <div class="auth-divider">
          <span>or</span>
        </div>
        
        <p class="auth-switch">
          Don't have an account? 
          <a href="#" id="show-signup" class="auth-link">Sign up</a>
        </p>
      </form>
    </div>

    <!-- Signup Form -->
    <div id="signup-form" class="auth-form" style="display: none;">
      <div class="auth-header">
        <h2>Join Inspire</h2>
        <p>Save your favorite ideas</p>
      </div>
      
      <form id="signupForm" class="auth-form-content">
        <div class="form-group">
          <label for="signup-username">Username</label>
          <input type="text" id="signup-username" placeholder="Pick a username" required>
        </div>
        
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="you@example.com" required>
        </div>
        
        <div class="form-group">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="At least 6 characters" minlength="6" required>
        </div>
        
        <button type="submit" class="auth-btn">Continue</button>
        
        <div class="auth-divider">
          <span>or</span>
        </div>
        
        <p class="auth-switch">
          Already have an account? 
          <a href="#" id="show-login" class="auth-link">Log in</a>
        </p>
      </form>
    </div>
  </div>
</div>

<!-- User Profile Section in Dropdown (will be added dynamically) -->

<nav class="navbar">
  <div class="logo">
    <span>üìå</span> Inspire
  </div>

  <div class="profile">
    <button class="profile-btn" id="profileBtn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <circle cx="12" cy="8" r="4"/>
        <path d="M4 20c2-4 14-4 16 0"/>
      </svg>
    </button>

<div class="dropdown" id="dropdown">
  <!-- User Profile Section (Shown when logged in) -->
  <div id="userProfileSection" style="display: none;">
    <div class="user-info">
      <div class="user-avatar" id="userAvatar">U</div>
      <div class="user-details">
        <h4 id="userName">User Name</h4>
        <p id="userEmail">user@example.com</p>
      </div>
    </div>
    <button class="drop-item" id="logoutBtn">üö™ Log Out</button>
  </div>

  <!-- Auth Section (Shown when logged out) -->
  <button class="drop-item" id="loginDropdownBtn" style="display: none;">
    üîë Login / Sign Up
  </button>

  <!-- Common Items -->
  <button class="drop-item" id="uploadItem">
    üì∑ Upload Photos
  </button>

  <button class="drop-item" id="toggleDark">
    üåô Dark Mode
    <div class="switch" id="switch"></div>
  </button>

  <button class="drop-item" id="clearItem">
    üóëÔ∏è Clear All Data
  </button>
</div>
</nav>

<!-- File Input (Hidden) -->
<input type="file" id="fileInput" class="upload-button" accept="image/*" multiple style="display: none;">

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading your inspiration...</div>
</div>

<!-- Main Content -->
<main class="main-content">
  <div class="grid" id="grid">
    <!-- Images will be loaded here -->
  </div>
</main>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <button class="modal-close" id="modalClose">√ó</button>
    </div>
    <div class="modal-content">
      <div class="main-image-container">
        <img class="main-image" id="mainImage" src="" alt="">
        <!-- Note bubble will be added here dynamically -->
      </div>
      <div class="related-container">
        <div class="related-title">
          <span>üí≠</span>
          <span>More inspiration for you</span>
        </div>
        <div class="related-grid" id="relatedGrid">
          <!-- Related images will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Heart Animation -->
<div class="heart-animation" id="heartAnimation">‚ù§Ô∏è</div>

<!-- Note Editor -->
<div class="note-editor-overlay" id="noteEditorOverlay">
  <div class="note-editor">
    <div class="note-editor-title">
      <span>üí≠</span>
      <span>Add a note</span>
    </div>
    <textarea class="note-editor-textarea" id="noteEditorTextarea" 
              placeholder="What does this remind you of? ‚ú®"></textarea>
    <div class="note-editor-buttons">
      <button class="editor-button cancel" id="noteEditorCancel">Cancel</button>
      <button class="editor-button save" id="noteEditorSave">Save Note</button>
    </div>
  </div>
</div>

<!-- Image Counter -->
<div class="image-counter" id="imageCounter">
  <span>üñºÔ∏è</span>
  <span id="counterText">0 images</span>
</div>

<!-- Notification -->
<div class="notification" id="notification">
  <span id="notificationIcon">‚ú®</span>
  <span id="notificationText">Notification</span>
</div>

<!-- Idle Message -->
<div class="idle-message" id="idleMessage">
  <div class="idle-icon">üìå</div>
  <div class="idle-title">Welcome to Inspire Board!</div>
  <div class="idle-text">
    Upload your favorite images to create your personal inspiration board.
    Double-tap images to like them, and add notes to remember why they inspire you.
  </div>
  <button class="empty-state-button" onclick="hideIdleMessage()">Get Started</button>
</div>

<script type="module">
// Import Supabase client
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// Define the Supabase URL and Key
const supabaseUrl = 'https://ibbdbjqzmlycurodzwac.supabase.co';
const supabaseKey = 'sb_publishable__qoEEEAF1eIvDBFtjZHGHw_lIl_u51Z';

// Initialize Supabase client
const supabase = createClient(supabaseUrl, supabaseKey);

// DOM Elements
const profileBtn = document.getElementById('profileBtn');
const dropdown = document.getElementById('dropdown');
const uploadItem = document.getElementById('uploadItem');
const clearItem = document.getElementById('clearItem');
const toggleDark = document.getElementById('toggleDark');
const switchEl = document.getElementById('switch');
const grid = document.getElementById('grid');
const modalOverlay = document.getElementById('modalOverlay');
const mainImage = document.getElementById('mainImage');
const relatedGrid = document.getElementById('relatedGrid');
const modalClose = document.getElementById('modalClose');
const heartAnimation = document.getElementById('heartAnimation');
const noteEditorOverlay = document.getElementById('noteEditorOverlay');
const noteEditorTextarea = document.getElementById('noteEditorTextarea');
const noteEditorCancel = document.getElementById('noteEditorCancel');
const noteEditorSave = document.getElementById('noteEditorSave');
const imageCounter = document.getElementById('imageCounter');
const counterText = document.getElementById('counterText');
const notification = document.getElementById('notification');
const notificationIcon = document.getElementById('notificationIcon');
const notificationText = document.getElementById('notificationText');
const fileInput = document.getElementById('fileInput');
const idleMessage = document.getElementById('idleMessage');
const loadingOverlay = document.getElementById('loadingOverlay');

// Auth DOM Elements
const authContainer = document.getElementById('auth-container');
const loginFormDiv = document.getElementById('login-form');
const signupFormDiv = document.getElementById('signup-form');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const loginEmailInput = document.getElementById('login-email');
const loginPasswordInput = document.getElementById('login-password');
const signupUsernameInput = document.getElementById('signup-username');
const signupEmailInput = document.getElementById('signup-email');
const signupPasswordInput = document.getElementById('signup-password');
const showSignupBtn = document.getElementById('show-signup');
const showLoginBtn = document.getElementById('show-login');
const loginDropdownBtn = document.getElementById('loginDropdownBtn');
const userProfileSection = document.getElementById('userProfileSection');
const userAvatar = document.getElementById('userAvatar');
const userName = document.getElementById('userName');
const userEmail = document.getElementById('userEmail');
const logoutBtn = document.getElementById('logoutBtn');

// State
let images = [];
let currentImageIndex = 0;
let editingNoteIndex = null;
let TAP_DELAY = 300;
let lastTapTime = 0;
let IDLE_TIMEOUT = 10000;
let idleTimer;
let currentUser = null;

// Bucket name - IMPORTANT: This must match your Supabase bucket name exactly
const BUCKET_NAME = 'inspire-board';

// Rose petal emojis
const PETALS = ['üåπ', 'ü•Ä', 'üå∫', 'üå∑', 'üå∏', 'üíÆ', 'üèµÔ∏è'];

// ==================== AUTHENTICATION FUNCTIONS ====================

// Show/Hide Auth Forms
function showAuthContainer(show) {
  if (show) {
    authContainer.style.display = 'flex';
    document.querySelector('.main-content').style.display = 'none';
    imageCounter.style.display = 'none';
  } else {
    authContainer.style.display = 'none';
    document.querySelector('.main-content').style.display = 'block';
    if (images.length > 0) imageCounter.style.display = 'flex';
  }
}

// Toggle between login and signup
showSignupBtn?.addEventListener('click', (e) => {
  e.preventDefault();
  loginFormDiv.style.display = 'none';
  signupFormDiv.style.display = 'block';
});

showLoginBtn?.addEventListener('click', (e) => {
  e.preventDefault();
  signupFormDiv.style.display = 'none';
  loginFormDiv.style.display = 'block';
});

// Check if user is logged in on page load
async function checkAuthStatus() {
  try {
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.error('Error checking session:', error);
      showAuthContainer(true);
      updateDropdownForLoggedInUser(false);
      return;
    }
    
    if (session) {
      // User is logged in
      currentUser = session.user;
      updateUserProfileUI();
      await loadUserImages();
      showAuthContainer(false);
      updateDropdownForLoggedInUser(true);
    } else {
      // User is not logged in
      showAuthContainer(true);
      updateDropdownForLoggedInUser(false);
    }
  } catch (error) {
    console.error('Error in checkAuthStatus:', error);
    showAuthContainer(true);
    updateDropdownForLoggedInUser(false);
  }
}

// Update dropdown based on auth state
function updateDropdownForLoggedInUser(isLoggedIn) {
  if (isLoggedIn) {
    userProfileSection.style.display = 'block';
    loginDropdownBtn.style.display = 'none';
  } else {
    userProfileSection.style.display = 'none';
    loginDropdownBtn.style.display = 'block';
  }
}

// Update user profile UI
function updateUserProfileUI() {
  if (!currentUser) return;
  
  const email = currentUser.email || '';
  const name = currentUser.user_metadata?.username || email.split('@')[0] || 'User';
  
  // Set user initials for avatar
  const initials = name.charAt(0).toUpperCase();
  userAvatar.textContent = initials;
  
  // Set random avatar color
  const hue = Math.floor(Math.random() * 360);
  userAvatar.style.backgroundColor = `hsl(${hue}, 70%, 60%)`;
  
  // Update user info
  userName.textContent = name;
  userEmail.textContent = email;
}

// Sign Up Function
signupForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const username = signupUsernameInput.value.trim();
  const email = signupEmailInput.value.trim();
  const password = signupPasswordInput.value;
  
  // Basic validation
  if (!username || !email || !password) {
    showNotification('Please fill all fields', '‚ö†Ô∏è');
    return;
  }
  
  if (password.length < 6) {
    showNotification('Password must be at least 6 characters', '‚ö†Ô∏è');
    return;
  }
  
  const submitBtn = signupForm.querySelector('.auth-btn');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Creating account...';
  submitBtn.disabled = true;
  
  try {
    // Sign up with Supabase Auth
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          username: username,
          avatar_color: `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`
        }
      }
    });
    
    if (error) {
      if (error.message.includes('already registered')) {
        showNotification('Email already registered', '‚ö†Ô∏è');
      } else if (error.message.includes('password')) {
        showNotification('Password is too weak', '‚ö†Ô∏è');
      } else {
        showNotification(`Sign up failed: ${error.message}`, '‚ùå');
      }
      return;
    }
    
    if (data.user) {
      // Create user profile in the database
      try {
        const { error: profileError } = await supabase
          .from('profiles')
          .insert([
            {
              id: data.user.id,
              username: username,
              email: email,
              avatar_color: `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`,
              created_at: new Date()
            }
          ]);
        
        if (profileError) {
          console.error('Profile creation error:', profileError);
        }
      } catch (profileError) {
        console.error('Profile error:', profileError);
      }
      
      // Check if email confirmation is required
      if (data.user.identities?.length === 0) {
        showNotification('Email already registered. Please login.', '‚ÑπÔ∏è');
        signupFormDiv.style.display = 'none';
        loginFormDiv.style.display = 'block';
      } else if (!data.user.email_confirmed_at) {
        showNotification('Account created! Please check your email to confirm.', 'üìß');
        signupFormDiv.style.display = 'none';
        loginFormDiv.style.display = 'block';
      } else {
        // Auto-login if email confirmed
        currentUser = data.user;
        updateUserProfileUI();
        showAuthContainer(false);
        updateDropdownForLoggedInUser(true);
        showNotification(`Welcome to Inspire, ${username}!`, 'üéâ');
      }
    }
    
  } catch (error) {
    console.error('Sign up error:', error);
    showNotification('Sign up failed. Please try again.', '‚ùå');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

// Login Function
loginForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = loginEmailInput.value.trim();
  const password = loginPasswordInput.value;
  
  if (!email || !password) {
    showNotification('Please fill all fields', '‚ö†Ô∏è');
    return;
  }
  
  const submitBtn = loginForm.querySelector('.auth-btn');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Logging in...';
  submitBtn.disabled = true;
  
  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) {
      if (error.message.includes('Invalid login credentials')) {
        showNotification('Invalid email or password', '‚ùå');
      } else if (error.message.includes('Email not confirmed')) {
        showNotification('Please confirm your email first', 'üìß');
      } else {
        showNotification(`Login failed: ${error.message}`, '‚ùå');
      }
      return;
    }
    
    if (data.user) {
      currentUser = data.user;
      updateUserProfileUI();
      await loadUserImages();
      showAuthContainer(false);
      updateDropdownForLoggedInUser(true);
      showNotification(`Welcome back, ${currentUser.user_metadata?.username || 'User'}!`, 'üëã');
      
      // Reset form
      loginForm.reset();
    }
    
  } catch (error) {
    console.error('Login error:', error);
    showNotification('Login failed. Please try again.', '‚ùå');
  } finally {
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
  }
});

// Logout Function
logoutBtn?.addEventListener('click', async () => {
  try {
    await supabase.auth.signOut();
    currentUser = null;
    images = [];
    renderGrid();
    showAuthContainer(true);
    updateDropdownForLoggedInUser(false);
    showNotification('Logged out successfully', 'üëã');
    
    // Reset forms
    loginForm.reset();
    signupForm.reset();
    
    // Show login form by default
    signupFormDiv.style.display = 'none';
    loginFormDiv.style.display = 'block';
    
  } catch (error) {
    console.error('Logout error:', error);
    showNotification('Logout failed', '‚ùå');
  }
});

// Login from dropdown
loginDropdownBtn?.addEventListener('click', () => {
  showAuthContainer(true);
  dropdown.classList.remove('show');
});

// ==================== DATABASE FUNCTIONS ====================

// Create images table if not exists
async function ensureTableExists() {
  try {
    // Check if images table exists
    const { error } = await supabase
      .from('images')
      .select('id')
      .limit(1);
    
    if (error && error.message.includes('does not exist')) {
      console.log('Images table does not exist. You need to create it in Supabase dashboard.');
      showNotification('Database table not found. Please create "images" table.', '‚ö†Ô∏è');
      return false;
    }
    
    return true;
  } catch (error) {
    console.error('Error checking table:', error);
    return false;
  }
}

// Load user-specific images
async function loadUserImages() {
  if (!currentUser) {
    images = [];
    renderGrid();
    return;
  }
  
  try {
    // First ensure table exists
    const tableExists = await ensureTableExists();
    if (!tableExists) {
      images = [];
      renderGrid();
      return;
    }

    const { data, error } = await supabase
      .from('images')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error loading user images:', error);
      images = [];
      return;
    }

    images = data || [];
    console.log('Loaded user images:', images.length);
    renderGrid();
    
  } catch (error) {
    console.error('Error in loadUserImages:', error);
    images = [];
  }
}

// ==================== FIXED UPLOAD FUNCTION ====================

async function uploadImage(file) {
  if (!currentUser) {
    showNotification('Please login to upload images', 'üîí');
    return;
  }
  
  console.log('=== UPLOAD STARTED ===');
  console.log('User:', currentUser.id, currentUser.email);
  console.log('File:', file.name, file.type, file.size);
  
  try {
    // Validate file
    if (!file.type.startsWith('image/')) {
      showNotification('Please upload an image file', '‚ùå');
      return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
      showNotification('File too large (max 5MB)', '‚ùå');
      return;
    }

    // Generate unique filename
    const fileExt = file.name.split('.').pop().toLowerCase();
    const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
    
    // Create user-specific folder structure
    const filePath = `${currentUser.id}/${fileName}`;
    
    console.log('Uploading to:', filePath);

    // Upload to storage
    const { data: storageData, error: storageError } = await supabase
      .storage
      .from(BUCKET_NAME)
      .upload(filePath, file, {
        cacheControl: '3600',
        upsert: false
      });

    if (storageError) {
      console.error('Storage upload error:', storageError);
      
      // Try to create user folder if it doesn't exist
      if (storageError.message?.includes('bucket not found')) {
        showNotification('‚ùå Storage bucket not found. Please create "inspire-board" bucket in Supabase Storage.', '‚ùå');
      } else if (storageError.statusCode === 403) {
        // Try simple path without user folder
        const simplePath = fileName;
        console.log('Trying simple path:', simplePath);
        
        const { data: simpleUpload, error: simpleError } = await supabase
          .storage
          .from(BUCKET_NAME)
          .upload(simplePath, file);
          
        if (simpleError) {
          showNotification('‚ùå Upload failed. Please check storage permissions.', '‚ùå');
        } else {
          // Success with simple path
          await processUploadSuccess(simplePath, fileName, file);
        }
        return;
      } else {
        showNotification(`‚ùå Upload failed: ${storageError.message || 'Unknown error'}`, '‚ùå');
      }
      return;
    }

    console.log('Storage upload successful:', storageData);
    await processUploadSuccess(filePath, fileName, file);
    
  } catch (error) {
    console.error('Unexpected upload error:', error);
    showNotification('Upload failed unexpectedly', '‚ùå');
  }
}

// Helper function to process successful upload
async function processUploadSuccess(filePath, fileName, file) {
  try {
    // Get public URL
    const { data: { publicUrl } } = supabase
      .storage
      .from(BUCKET_NAME)
      .getPublicUrl(filePath);
    
    console.log('Public URL:', publicUrl);

    if (!publicUrl) {
      showNotification('Could not get image URL', '‚ùå');
      return;
    }

    // Insert into database
    const imageData = {
      url: publicUrl,
      filename: fileName,
      filepath: filePath,
      note: '',
      liked: false,
      user_id: currentUser.id,
      created_at: new Date().toISOString()
    };
    
    console.log('Inserting into database:', imageData);
    
    const { data: newImage, error: insertError } = await supabase
      .from('images')
      .insert([imageData])
      .select()
      .single();

    if (insertError) {
      console.error('Database insert error:', insertError);
      showNotification('Failed to save image to database', '‚ùå');
      
      // Try to clean up storage file
      try {
        await supabase.storage.from(BUCKET_NAME).remove([filePath]);
        console.log('Cleaned up orphaned file');
      } catch (cleanupError) {
        console.error('Cleanup failed:', cleanupError);
      }
      
      return;
    }

    console.log('Database insert successful:', newImage);

    // Update UI
    images.unshift(newImage);
    renderGrid();
    showNotification('Image uploaded successfully!', 'üì∏');
    hideIdleMessage();
    
    console.log('=== UPLOAD COMPLETE ===');
    return newImage;
    
  } catch (error) {
    console.error('Error in processUploadSuccess:', error);
    showNotification('Failed to process uploaded image', '‚ùå');
  }
}

// Update like or note in Supabase table
async function updateImage(id, changes) {
  try {
    const { error } = await supabase
      .from('images')
      .update(changes)
      .eq('id', id);

    if (error) {
      console.error('Error updating image:', error);
      throw error;
    }
  } catch (error) {
    console.error('Error in updateImage:', error);
    throw error;
  }
}

// Delete image from Supabase storage & table
async function deleteImageSupabase(id, url, filepath) {
  try {
    // Delete from table first
    const { error: tableError } = await supabase
      .from('images')
      .delete()
      .eq('id', id);

    if (tableError) {
      console.error('Error deleting from table:', tableError);
      throw tableError;
    }

    // Delete from storage if filepath exists
    if (filepath) {
      try {
        const { error: storageError } = await supabase
          .storage
          .from(BUCKET_NAME)
          .remove([filepath]);
        
        if (storageError) {
          console.error('Storage delete error:', storageError);
        }
      } catch (storageError) {
        console.error('Storage deletion failed:', storageError);
      }
    }

    showNotification('Image deleted', 'üóëÔ∏è');
    return true;
  } catch (error) {
    console.error('Error in deleteImageSupabase:', error);
    showNotification('Delete failed', '‚ùå');
    throw error;
  }
}

// ==================== STORAGE TEST FUNCTION ====================

async function testStorageConnection() {
  console.log('Testing storage connection...');
  
  try {
    // Try to list files in the bucket
    const { data, error } = await supabase.storage.from(BUCKET_NAME).list();
    
    if (error) {
      console.error('Storage test failed:', error);
      
      if (error.message?.includes('not found') || error.statusCode === 404) {
        console.error('‚ùå Bucket not found. Please create it in Supabase Storage.');
        showNotification('Storage bucket not found. Please create "inspire-board" in Supabase Storage.', '‚ö†Ô∏è');
      } else if (error.statusCode === 403) {
        console.error('‚ùå Permission denied. Please check storage policies.');
        showNotification('Storage permission denied. Please check bucket policies.', '‚ö†Ô∏è');
      }
      
      return false;
    }
    
    console.log('‚úÖ Storage connection successful!');
    console.log('Files in bucket:', data?.length || 0);
    return true;
    
  } catch (error) {
    console.error('Storage test error:', error);
    return false;
  }
}

// ------------------- REALTIME -------------------
function setupRealtime() {
  try {
    // Subscribe to changes in images table
    const channel = supabase
      .channel('images-channel')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'images' },
        async (payload) => {
          console.log('Database change received:', payload.eventType);
          await loadUserImages();
        }
      )
      .subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          console.log('Realtime subscription active');
        }
      });

    return () => supabase.removeChannel(channel);
  } catch (e) {
    console.warn('Realtime subscription failed:', e);
  }
}

// ------------------- UI FUNCTIONS -------------------

function hideLoading() {
  loadingOverlay.classList.add('hidden');
  setTimeout(() => {
    loadingOverlay.style.display = 'none';
  }, 500);

  if (images.length === 0) {
    idleMessage.classList.add('show');
  }
}

function renderGrid() {
  grid.innerHTML = '';
  if (!images.length) {
    imageCounter.style.display = 'none';
    return;
  }

  images.forEach((image, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.animationDelay = `${(index % 10) * 0.1}s`;

    const noteBubble = image.note ? `
      <div class="note-bubble" id="noteBubble${image.id}">
        <div class="note-content">${image.note}</div>
      </div>
    ` : '';

    card.innerHTML = `
      ${noteBubble}
      <div class="three-dot-menu">
        <button class="menu-button" onclick="showMenu(event, ${index})">‚ãØ</button>
        <div class="menu-dropdown" id="menuDropdown${index}">
          <button class="menu-item" onclick="editNote(${index})">
            <span>üí≠</span> ${image.note ? 'Edit Note' : 'Add Note'}
          </button>
          <button class="menu-item" onclick="copyImage(${index})">
            <span>üìã</span> Copy Image URL
          </button>
          <button class="menu-item delete" onclick="deleteImageHandler(${index})">
            <span>üóëÔ∏è</span> Delete
          </button>
        </div>
      </div>
      <div class="card-actions">
        <button class="action-button ${image.liked ? 'liked' : ''}" 
                onclick="toggleLike(${index})">
          ${image.liked ? '‚ù§Ô∏è' : 'ü§ç'}
        </button>
      </div>
    `;

    // Create image element
    const img = document.createElement('img');
    img.className = 'card-image loading';
    img.src = image.url;
    img.dataset.index = index;
    img.alt = 'Inspiration image';
    img.onload = () => {
      img.classList.replace('loading', 'loaded');
    };
    img.onerror = () => {
      console.error('Failed to load image:', image.url);
      img.alt = 'Failed to load image';
      img.classList.replace('loading', 'loaded');
    };
    
    // Insert image at the beginning
    card.insertBefore(img, card.firstChild);
    
    // Add double-tap handler for mobile
    let lastTouchTime = 0;
    card.addEventListener('touchstart', (e) => {
      const currentTime = new Date().getTime();
      const tapLength = currentTime - lastTouchTime;
      if (tapLength < TAP_DELAY && tapLength > 0) {
        // Double tap detected
        toggleLike(index);
        e.preventDefault();
      }
      lastTouchTime = currentTime;
    });
    
    // Add double-click handler for desktop
    card.addEventListener('dblclick', () => toggleLike(index));
    
    // Add click handler for modal
    img.addEventListener('click', () => openModal(index));
    
    grid.appendChild(card);
  });

  updateCounter();
}

// ------------------- MODAL FUNCTIONS -------------------

function openModal(index) {
  currentImageIndex = index;
  const image = images[index];
  mainImage.src = image.url;
  
  // Show note bubble if exists
  const existingBubble = document.querySelector('.main-image-container .note-bubble');
  if (existingBubble) {
    existingBubble.remove();
  }
  
  if (image.note) {
    const noteBubble = document.createElement('div');
    noteBubble.className = 'note-bubble show';
    noteBubble.innerHTML = `<div class="note-content">${image.note}</div>`;
    document.querySelector('.main-image-container').appendChild(noteBubble);
  }
  
  // Load related images
  loadRelatedImages(index);
  modalOverlay.style.display = 'flex';
}

function loadRelatedImages(currentIndex) {
  relatedGrid.innerHTML = '';
  const relatedImages = images.filter((_, idx) => idx !== currentIndex).slice(0, 6);
  
  relatedImages.forEach((img, idx) => {
    const card = document.createElement('div');
    card.className = 'related-card';
    const imgIndex = images.findIndex(i => i.id === img.id);
    const imgEl = document.createElement('img');
    imgEl.src = img.url;
    imgEl.alt = 'Related image';
    imgEl.dataset.index = imgIndex;
    
    card.appendChild(imgEl);
    card.addEventListener('click', () => {
      openModal(imgIndex);
    });
    relatedGrid.appendChild(card);
  });
}

// ------------------- IMAGE ACTIONS -------------------

function toggleLike(index) {
  const image = images[index];
  const newLikedState = !image.liked;
  image.liked = newLikedState;
  
  // Update UI immediately
  const card = document.querySelector(`[data-index="${index}"]`)?.closest('.card');
  if (card) {
    const likeBtn = card.querySelector('.action-button');
    if (likeBtn) {
      likeBtn.textContent = newLikedState ? '‚ù§Ô∏è' : 'ü§ç';
      likeBtn.classList.toggle('liked', newLikedState);
    }
  }
  
  updateImage(image.id, { liked: newLikedState })
    .catch(error => {
      // Revert on error
      image.liked = !newLikedState;
      showNotification('Failed to update like', '‚ùå');
    });

  showHeartOnCard(index);
  showNotification(
    newLikedState ? 'Added to favorites' : 'Removed from favorites',
    newLikedState ? '‚ù§Ô∏è' : 'üíî'
  );
}

function editNote(index) {
  editingNoteIndex = index;
  noteEditorTextarea.value = images[index].note || '';
  noteEditorOverlay.style.display = 'flex';
  // Close any open menus
  document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
}

function saveNote() {
  if (editingNoteIndex !== null) {
    const image = images[editingNoteIndex];
    const newNote = noteEditorTextarea.value.trim();
    const oldNote = image.note;
    image.note = newNote;
    
    // Update UI immediately
    const card = document.querySelector(`[data-index="${editingNoteIndex}"]`)?.closest('.card');
    if (card) {
      const noteBubble = card.querySelector('.note-bubble');
      if (newNote && !noteBubble) {
        const newNoteBubble = document.createElement('div');
        newNoteBubble.className = 'note-bubble';
        newNoteBubble.id = `noteBubble${image.id}`;
        newNoteBubble.innerHTML = `<div class="note-content">${newNote}</div>`;
        card.insertBefore(newNoteBubble, card.firstChild);
      } else if (newNote && noteBubble) {
        noteBubble.querySelector('.note-content').textContent = newNote;
      } else if (!newNote && noteBubble) {
        noteBubble.remove();
      }
    }
    
    updateImage(image.id, { note: newNote })
      .then(() => {
        showNotification('Note saved', 'üí≠');
      })
      .catch(error => {
        // Revert on error
        image.note = oldNote;
        showNotification('Failed to save note', '‚ùå');
      });
    
    editingNoteIndex = null;
    noteEditorOverlay.style.display = 'none';
  }
}

function deleteImageHandler(index) {
  const image = images[index];
  if (confirm('Delete this image? This cannot be undone.')) {
    const imageToDelete = images[index];
    
    // Remove from local array immediately
    images.splice(index, 1);
    renderGrid();
    
    deleteImageSupabase(imageToDelete.id, imageToDelete.url, imageToDelete.filepath)
      .catch(error => {
        // Add back if delete failed
        images.splice(index, 0, imageToDelete);
        renderGrid();
        showNotification('Delete failed. Please try again.', '‚ùå');
      });
    
    // Close menu
    document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
  }
}

async function copyImage(index) {
  try {
    const url = images[index]?.url;
    if (!url) {
      showNotification('No URL to copy', '‚ö†Ô∏è');
      return;
    }
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(url);
    } else {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = url;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      document.execCommand('copy');
      textArea.remove();
    }
    showNotification('Image URL copied to clipboard', 'üìã');
  } catch (e) {
    console.error('Copy failed', e);
    showNotification('Copy failed', '‚ùå');
  }
}

// ------------------- OTHER UI FUNCTIONS -------------------

function showHeartOnCard(index) {
  const card = document.querySelector(`[data-index="${index}"]`)?.closest('.card');
  if (!card) return;
  const rect = card.getBoundingClientRect();
  heartAnimation.style.left = `${rect.left + rect.width/2}px`;
  heartAnimation.style.top = `${rect.top + rect.height/2}px`;
  heartAnimation.classList.add('show');
  setTimeout(() => heartAnimation.classList.remove('show'), 1000);
  createRosePetals(rect.left + rect.width/2, rect.top + rect.height/2);
}

function showNotification(message, icon = '‚ú®') {
  notificationIcon.textContent = icon;
  notificationText.textContent = message;
  notification.classList.add('show');
  setTimeout(() => notification.classList.remove('show'), 2000);
}

function updateCounter() {
  const count = images.length;
  counterText.textContent = `${count} image${count !== 1 ? 's' : ''}`;
  imageCounter.style.display = count > 0 ? 'flex' : 'none';
}

function hideIdleMessage() {
  idleMessage.classList.remove('show');
  resetIdleTimer();
}

function showMenu(event, index) {
  event.stopPropagation();
  // Close other menus
  document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
  const menu = document.getElementById(`menuDropdown${index}`);
  if (menu) menu.classList.toggle('show');
}

// ------------------- ROSE PETALS -------------------

function createRosePetals(x = window.innerWidth/2, y = 0, count = 20) {
  for (let i = 0; i < count; i++) {
    const petal = document.createElement('div');
    petal.className = 'petal';
    petal.textContent = PETALS[Math.floor(Math.random()*PETALS.length)];
    petal.style.left = `${x + (Math.random()-0.5)*200}px`;
    petal.style.top = `${y}px`;
    petal.style.fontSize = `${16 + Math.random()*12}px`;
    petal.style.animationDuration = `${2 + Math.random()*2}s`;
    document.body.appendChild(petal);
    setTimeout(() => petal.remove(), 4000);
  }
}

// ------------------- IDLE TIMER -------------------

function setupIdleTimer() {
  resetIdleTimer();
  document.addEventListener('mousemove', resetIdleTimer);
  document.addEventListener('keypress', resetIdleTimer);
  document.addEventListener('touchstart', resetIdleTimer);
  document.addEventListener('scroll', resetIdleTimer);
}

function resetIdleTimer() {
  clearTimeout(idleTimer);
  if (images.length === 0) {
    idleTimer = setTimeout(() => {
      idleMessage.classList.add('show');
    }, IDLE_TIMEOUT);
  }
}

// ------------------- CLEAR ALL DATA -------------------

async function clearAllData() {
  if (!currentUser) {
    showNotification('Please login to clear data', 'üîí');
    return;
  }
  
  if (!confirm('Are you sure you want to delete ALL your images? This cannot be undone.')) {
    return;
  }
  
  if (images.length === 0) {
    showNotification('No images to delete', '‚ÑπÔ∏è');
    return;
  }
  
  showNotification('Deleting all your images...', '‚è≥');
  
  try {
    // Delete only user's images from storage
    const userFilepaths = images
      .filter(img => img.user_id === currentUser.id)
      .map(img => img.filepath)
      .filter(Boolean);
    
    if (userFilepaths.length > 0) {
      await supabase.storage.from(BUCKET_NAME).remove(userFilepaths);
    }
    
    // Delete only user's images from database
    await supabase
      .from('images')
      .delete()
      .eq('user_id', currentUser.id);
    
    // Clear local state
    images = [];
    renderGrid();
    idleMessage.classList.add('show');
    showNotification('All your images have been deleted', 'üóëÔ∏è');
    
  } catch (error) {
    console.error('Error clearing user data:', error);
    showNotification('Failed to delete images', '‚ùå');
  }
}

// ------------------- INITIALIZE -------------------
async function initialize() {
  // Initialize dark mode
  const savedTheme = localStorage.getItem('inspireTheme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
    switchEl.classList.add('active');
  }
  
  // Check auth status first
  await checkAuthStatus();
  
  // Test storage connection
  await testStorageConnection();
  
  // Only load images if user is logged in
  if (currentUser) {
    await loadUserImages();
  }
  
  renderGrid();
  setupRealtime();
  setupIdleTimer();
  hideLoading();
  
  // Listen for auth state changes
  supabase.auth.onAuthStateChange(async (event, session) => {
    console.log('Auth state changed:', event);
    
    if (session) {
      currentUser = session.user;
      updateUserProfileUI();
      await loadUserImages();
      showAuthContainer(false);
      updateDropdownForLoggedInUser(true);
    } else {
      // User signed out
      currentUser = null;
      images = [];
      renderGrid();
      showAuthContainer(true);
      updateDropdownForLoggedInUser(false);
    }
  });
}

// ------------------- EVENT LISTENERS -------------------

profileBtn.addEventListener('click', e => {
  e.stopPropagation();
  dropdown.classList.toggle('show');
});

document.addEventListener('click', (e) => {
  // Close dropdowns when clicking outside
  if (!dropdown.contains(e.target) && e.target !== profileBtn) {
    dropdown.classList.remove('show');
  }
  
  // Close menu dropdowns when clicking outside
  if (!e.target.closest('.three-dot-menu')) {
    document.querySelectorAll('.menu-dropdown').forEach(menu => menu.classList.remove('show'));
  }
});

uploadItem.addEventListener('click', () => {
  if (!currentUser) {
    showNotification('Please login to upload images', 'üîí');
    return;
  }
  fileInput.click();
});

fileInput.addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  if (files.length === 0) return;
  
  showNotification(`Uploading ${files.length} image${files.length > 1 ? 's' : ''}...`, '‚è≥');
  
  // Upload files sequentially
  for (let file of files) {
    await uploadImage(file);
  }
  
  fileInput.value = '';
});

toggleDark.addEventListener('click', () => {
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('inspireTheme', isDark ? 'dark' : 'light');
  switchEl.classList.toggle('active');
  showNotification(isDark ? 'Dark mode enabled' : 'Light mode enabled', isDark ? 'üåô' : '‚òÄÔ∏è');
});

clearItem.addEventListener('click', clearAllData);

modalClose.addEventListener('click', () => {
  modalOverlay.style.display = 'none';
  // Remove note bubble from modal
  const noteBubble = document.querySelector('.main-image-container .note-bubble');
  if (noteBubble) noteBubble.remove();
});

noteEditorCancel.addEventListener('click', () => {
  noteEditorOverlay.style.display = 'none';
  editingNoteIndex = null;
});

noteEditorSave.addEventListener('click', saveNote);

// Handle Enter key in note editor
noteEditorTextarea.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    saveNote();
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    noteEditorOverlay.style.display = 'none';
    modalOverlay.style.display = 'none';
    editingNoteIndex = null;
    dropdown.classList.remove('show');
    document.querySelectorAll('.menu-dropdown').forEach(m => m.classList.remove('show'));
  }
});

// Expose functions used by inline onclick attributes to global scope
window.showMenu = showMenu;
window.editNote = editNote;
window.copyImage = copyImage;
window.deleteImageHandler = deleteImageHandler;
window.toggleLike = toggleLike;
window.hideIdleMessage = hideIdleMessage;

// ------------------- INITIALIZE APP -------------------

initialize();
</script>
</body>
</html>

